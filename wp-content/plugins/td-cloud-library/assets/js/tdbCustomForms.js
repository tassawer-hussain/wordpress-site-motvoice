var tdbCustomForms={};jQuery().ready(function(){tdbCustomForms.init()});
(function(){tdbCustomForms={items:[],item:function(){this.formType=this.blockObj=this.uid="";this.formData=new FormData;this.customPostTitleField=this.cloudTplID=this.successURL=this.currentUserID=this.formGroupClass="";this.enablePostCreate=!1;this.tpl_id=this._nonce=this.higher_msg=this.lower_msg=this.valid_email_msg=this.blank_fields_msg=this.required_field_error=this.emailSubject=this.sendEmailToEmailFromField=this.sendEmailToCustomAddr=this.sendEmailToAuthor=this.sendEmailToAdmin=this.enableEmailSubmit=
this.makeChild=this.linkToPostID=this.postStatus=this.postFormat=this.postType=this.postID="";this._is_initialized=this._in_composer=!1},init:function(){tdbCustomForms.items=[];this._is_running=!1},_initialize_item:function(a){!0!==a._is_initialized&&(a.blockObj.find(".tdb-s-btn").on("click",function(d){d.preventDefault();d=a.blockObj.find(".tdb-s-form");var e=jQuery(a.formGroupClass+".tdb-s-form-group"),c={},b=!1;a.formData=new FormData;e.removeClass("tdb-s-fg-error");e.find(".tdb-s-fg-error-msg").remove();
d.find(".tdb-s-notif").remove();e=tdbCustomForms.getFormContentElements(a);c["content-fields"]=e.elements;e.hasErrors&&(b=e.hasErrors);e=tdbCustomForms.getFormFileElements(a);c["file-delete-fields"]=e.deleteElements;e.hasErrors&&(b=e.hasErrors);e=tdbCustomForms.getFormGalleryElements(a);c.galleries=e.elements;e.hasErrors&&(b=e.hasErrors);e=tdbCustomForms.getFormACFElements(a);c["acf-fields"]=e.elements;"post"===a.formType&&""!==e.postTitle&&(c["post-title"]=e.postTitle);e.hasErrors&&(b=e.hasErrors);
if("post"===a.formType){e=tdbCustomForms.getFormTaxonomyElements(a);c.taxonomies=e.elements;e.hasErrors&&(b=e.hasErrors);e=tdbCustomForms.getFormLocationElement(a);c["location-data"]=e.element;e.hasErrors&&(b=e.hasErrors);e=tdbCustomForms.getFormTitleElement(a);"undefined"===typeof c["post-title"]&&(c["post-title"]=e.postTitle);e.hasErrors&&(b=e.hasErrors);e=tdbCustomForms.getLinkToPostElement(a);var f=e.linkToPostID;e.hasErrors&&(b=e.hasErrors);""!==f&&(a.linkToPostID=f,a.makeChild=e.makeChild)}if(b)d.prepend('<div class="tdb-s-notif tdb-s-notif-sm tdb-s-notif-error"><div class="tdb-s-notif-descr">'+
a.blank_fields_msg+"</div></div>");else if(a.formData.append("formElements",JSON.stringify(c)),a.formData.append("enctype","multipart/form-data"),a.formData.append("_nonce",a._nonce),"user"===a.formType)a.formData.append("action","tdb_user_form_on_submit"),tdbCustomForms.userFormAjaxCall(a);else if("post"===a.formType)if(a.formData.append("action","tdb_posts_form_on_submit"),a.formData.append("enablePostCreate",a.enablePostCreate),a.formData.append("postID",a.postID),a.formData.append("authorID",
a.currentUserID),a.formData.append("postType",a.postType),a.formData.append("postFormat",a.postFormat),a.formData.append("postStatus",a.postStatus),a.formData.append("cloudTplID",a.cloudTplID),a.formData.append("linkToPostID",a.linkToPostID),a.formData.append("makeChild",a.makeChild),a.formData.append("cfInputEmailList",a.cfInputEmailList),a.formData.append("emailList",a.emailList),a.formData.append("enableEmailSubmit",a.enableEmailSubmit),a.formData.append("sendEmailToAdmin",a.sendEmailToAdmin),
a.formData.append("sendEmailToAuthor",a.sendEmailToAuthor),a.formData.append("sendEmailToCustomAddr",a.sendEmailToCustomAddr),a.formData.append("sendEmailToEmailFromField",a.sendEmailToEmailFromField),a.formData.append("emailSubject",a.emailSubject),a.formData.append("tpl_id",a.tpl_id),d=a.blockObj.find("#g-recaptcha"),d.length){var g=d.attr("data-sitekey"),h="";grecaptcha.ready(function(){grecaptcha.execute(g,{action:"submit"}).then(function(b){h=b;a.formData.append("captcha",h);tdbCustomForms.postFormAjaxCall(a)})})}else tdbCustomForms.postFormAjaxCall(a)}),
a._is_initialized=!0)},getFormContentElements:function(a){var d=[],e=!1;jQuery(a.formGroupClass+".tdb_form_content").each(function(){var c=jQuery(this),b=c.data("required"),f=c.data("custom-field"),g=c.data("form-type"),h=c.find(".tdb-s-form-group"),l=c.find(".tdb-s-form-label").text().replace(" *",""),m=c.find("textarea");c=c.find(".wp-editor-wrap");var k="";g===a.formType&&(k=c.hasClass("tmce-active")?tinymce.get(m.attr("id")).getContent():m.val(),d.filter(function(a){return a.name===f}).length||
(1===b&&""===k?(h.addClass("tdb-s-fg-error"),h.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),e=!0):(b=encodeURIComponent(k).replace(/%([0-9A-F]{2})/g,function(a,b){return String.fromCharCode("0x"+b)}),l={name:f,value:btoa(b),label:l},d.push(l))))});return{elements:d,hasErrors:e}},getFormFileElements:function(a){var d=[],e=!1;jQuery(a.formGroupClass+".tdb_form_file_upload").each(function(){var c=jQuery(this),b=c.data("form-type"),f=c.data("required"),g=c.data("no-save"),
h=c.data("custom-field"),l=c.find(".tdb-s-form-group");c=c.find("input");var m=c.val();b===a.formType&&""!==h&&!1===g&&(1===f&&""===m?(l.addClass("tdb-s-fg-error"),l.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),e=!0):(a.formData.append(h,c.prop("files")[0]),""===m&&d.push(h)))});return{deleteElements:d,hasErrors:e}},getFormGalleryElements:function(a){var d=[],e=!1;jQuery(a.formGroupClass+".tdb_form_gallery").each(function(){var c=jQuery(this),b=c.data("form-type"),
f=c.data("custom-field");if(b===a.formType&&!d.filter(function(a){return a.name===f}).length){var g=c.data("required"),h=c.find(".tdb-s-form-group");b=c.find(".tdb-fg-item:not(.tdb-fg-item-add)").filter(function(){return""!=jQuery(this).attr("data-img-id")});c=c.find(".tdb-fg-input");1!==g||c.length||b.length?(c.length&&c.each(function(b){var c=jQuery(this);a.formData.append("tdb_gallery_{"+f+"}_"+b,c.prop("files")[0])}),c=[],b.length&&(c=jQuery.map(b,function(a,b){return jQuery(a).data("image-id")})),
d.push({source:f,existingImagesIDs:c})):(h.addClass("tdb-s-fg-error"),h.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),e=!0)}});return{elements:d,hasErrors:e}},getFormACFElements:function(a){var d=[],e="",c=!1;jQuery(a.formGroupClass+".tdb-posts-form-acf-input").each(function(){var b=jQuery(this),f=b.data("form-type"),g=b.data("type"),h=b.data("required"),l=b.data("name"),m=b.find(".tdb-s-form-label").text().replace(" *",""),k=void 0;if(f===a.formType&&!d.filter(function(a){return a.name===
l}).length)switch(g){case "text":case "textarea":case "url":case "select":k=b.find(".tdb-s-form-input");var n=k.val();1===h&&""===k.val()?(b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),c=!0):(m={name:l,value:n,label:m,type:g},"select"===g?(jQuery.isArray(n)?(n.forEach(function(a,b){n[b]={value:a,label:k.find('option[value="'+a+'"]').text()}}),m.type=g+"_multiple"):(n={value:n,label:k.find('option[value="'+n+'"]').text()},"post"===a.formType&&
l===a.customPostTitleField&&(e=n)),m.value=n):("textarea"===g&&(m.value=encodeURI(n)),"post"===a.formType&&l===a.customPostTitleField&&(e=n)),d.push(m));break;case "date_picker":case "date_time_picker":case "time_picker":k=b.find(".tdb-s-form-input.flatpickr-input");1===h&&""===k.val()?(b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),c=!0):(g={name:l,value:k.val(),label:m,type:g},d.push(g),"post"===a.formType&&l===a.customPostTitleField&&
(e=k.val()));break;case "email":f=/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;k=b.find(".tdb-s-form-input");1===h&&""===k.val()?(b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),c=!0):k.val().match(f)||""===k.val()?(g={name:l,value:k.val(),label:m,type:g},d.push(g),"post"===a.formType&&l===a.customPostTitleField&&(e=k.val())):(b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+a.valid_email_msg+"</span>"),c=!0);
break;case "number":k=b.find(".tdb-s-form-input");f=k.attr("min");var p=k.attr("max");1===h&&""===k.val()?(b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),c=!0):k.val()<f&&""!==k.val()?(b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+a.lower_msg+f+".</span>"),c=!0):k.val()>p&&""!==k.val()?(b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+a.higher_msg+p+".</span>"),c=!0):(g={name:l,value:k.val(),
label:m,type:g},d.push(g),"post"===a.formType&&l===a.customPostTitleField&&(e=k.val()));break;case "checkbox":if(1!==h||b.find("input:checked").length){var q=[];b.find("input:checked").each(function(){var a=jQuery(this);q.push({value:a.val(),label:a.siblings(".tdb-fi-check-label").text()})});d.push({name:l,value:q,label:m,type:g})}else b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),c=!0;break;case "radio":case "button_group":1!==h||b.find("input:checked").length?
(b=b.find("input:checked"),h={value:b.val(),label:b.siblings(".tdb-fi-check-label").text()},d.push({name:l,value:h,label:m,type:g}),"post"===a.formType&&l===a.customPostTitleField&&(e=b.siblings(".tdb-fi-check-label").text())):(b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),c=!0)}});return{elements:d,postTitle:e,hasErrors:c}},getFormTaxonomyElements:function(a){var d=[],e=!1;jQuery(a.formGroupClass+".tdb_form_taxonomies").each(function(){var c=
jQuery(this),b=c.data("tax-type"),f=c.data("required"),g=c.find('[data-term-hierarchy="parent"]'),h=g.data("display");c=c.find('[data-term-hierarchy="child"], [data-term-hierarchy="sub-child"]');var l=[];d.filter(function(a){return a.taxType===b}).length||("dropdown"===h?(h=g.find("select"),1===f&&""===h.val()?(g.addClass("tdb-s-fg-error"),g.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),e=!0):""!==h.val()&&l.push(parseInt(h.val()))):(h=g.find("input:checked"),1!==f||
h.length?h.each(function(){l.push(parseInt(jQuery(this).val()))}):(g.addClass("tdb-s-fg-error"),g.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),e=!0)),c.each(function(){var a=jQuery(this);"dropdown"===a.data("display")?(a=a.find("select"),""!==a.val()&&l.push(parseInt(a.val()))):a.find("input:checked").each(function(){l.push(parseInt(jQuery(this).val()))})}),l.length&&d.push({terms:l,taxType:b}))});return{elements:d,hasErrors:e}},getFormLocationElement:function(a){var d=
jQuery(a.formGroupClass+".tdb_location_finder").first(),e={},c=!1;if(d.length){var b=d.data("tax-type"),f=d.data("location-meta"),g=d.data("required"),h=d.find(".tdb-s-form-group-lf-search input"),l=h.closest(".tdb-s-form-group"),m=d.find(".tdb-s-form-group-lf-address input"),k=d.find(".tdb-s-form-group-lf-postal-code input"),n=d.find(".tdb-s-form-group-lf-city input"),p=d.find(".tdb-s-form-group-lf-state input");d=d.find(".tdb-s-form-group-lf-country input");1===g&&""===h.val()?(l.addClass("tdb-s-fg-error"),
l.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),c=!0):""!==n.val()&&""!==p.val()&&""!==d.val()&&(e={address:m.val(),postalCode:k.val(),city:n.val(),state:p.val(),country:d.val(),taxType:b,locationMeta:f})}return{element:e,hasErrors:c}},getFormTitleElement:function(a){var d=jQuery(a.formGroupClass+".tdb_form_title input").first(),e="",c=!1;if(d.length){d=d.first();var b=d.closest(".tdb-s-form-group");""===d.val()?(b.addClass("tdb-s-fg-error"),b.append('<span class="tdb-s-fg-error-msg">'+
a.required_field_error+"</span>"),c=!0):e=d.val()}return{postTitle:e,hasErrors:c}},getLinkToPostElement:function(a){var d=jQuery(a.formGroupClass+".tdb_form_link_post").first(),e="",c=!1,b=!1;if(d.length){var f=d.find("select"),g=d.find(".tdb-s-form-group");1===d.data("required")&&""===f.val()?(g.addClass("tdb-s-fg-error"),g.append('<span class="tdb-s-fg-error-msg">'+a.required_field_error+"</span>"),b=!0):(e=f.val(),c=d.data("make-child"))}return{linkToPostID:e,makeChild:c,hasErrors:b}},userFormAjaxCall:function(a){var d=
a.blockObj.find(".tdb-s-form"),e=jQuery(a.formGroupClass+".tdb-s-form-group"),c=a.blockObj.find(".tdb-s-btn");e.addClass("tdb-s-content-disabled");d.addClass("tdb-s-content-disabled");c.addClass("tdb-s-btn-saving");jQuery.ajax({method:"POST",url:td_ajax_url,data:a.formData,contentType:!1,processData:!1,success:function(b){b=jQuery.parseJSON(b);""!==b.success&&d.prepend('<div class="tdb-s-notif tdb-s-notif-sm tdb-s-notif-success"><div class="tdb-s-notif-descr">'+b.success+"</div></div>");if(b.errors.length){var f=
'<div class="tdb-s-notif tdb-s-notif-sm tdb-s-notif-error">';f+='<ul class="tdb-s-notif-list">';jQuery.each(b.errors,function(a,b){f+="<li>"+b+"</li>"});f+="</ul>";f+="</div>";d.prepend(f)}c.addClass("tdb-s-btn-saved");d.removeClass("tdb-s-content-disabled");setTimeout(function(){e.removeClass("tdb-s-content-disabled");c.removeClass("tdb-s-btn-saving").removeClass("tdb-s-btn-saved");setTimeout(function(){a.blockObj.find(".tdb-s-notif-success").remove();a.blockObj.find(".tdb-s-notif-error").remove()},
4E3)},200)}})},postFormAjaxCall:function(a){var d=a.blockObj.find(".tdb-s-form"),e=jQuery(a.formGroupClass+".tdb-s-form-group"),c=a.blockObj.find(".tdb-s-btn");e.addClass("tdb-s-content-disabled");d.addClass("tdb-s-content-disabled");c.addClass("tdb-s-btn-saving");jQuery.ajax({method:"POST",url:td_ajax_url,data:a.formData,contentType:!1,processData:!1,success:function(b){b=jQuery.parseJSON(b);if(""!==a.successURL&&""!==b.success.create_post&&""===a.postID)window.location.replace(a.successURL);else{if(""!==
b.success.create_post||""!==b.success.email){var f='<div class="tdb-s-notif tdb-s-notif-sm tdb-s-notif-success"><ul class="tdb-s-notif-list">';""!==b.success.create_post&&(f+="<li>"+b.success.create_post+"</li>");""!==b.success.email&&(f+="<li>"+b.success.email+"</li>");d.prepend(f+"</ul></div>")}if(""!==b.errors.create_post||""!==b.errors.email||""!==b.errors.permission)f='<div class="tdb-s-notif tdb-s-notif-sm tdb-s-notif-error"><ul class="tdb-s-notif-list">',""!==b.errors.create_post&&(f+="<li>"+
b.errors.create_post+"</li>"),""!==b.errors.email&&(f+="<li>"+b.errors.email+"</li>"),""!==b.errors.permission&&(f+="<li>"+b.errors.permission+"</li>"),d.prepend(f+"</ul></div>");c.addClass("tdb-s-btn-saved");d.removeClass("tdb-s-content-disabled");""!==b.success.create_post&&""===a.postID?setTimeout(function(){window.location.replace(window.location.pathname+window.location.search+window.location.hash)},1E3):setTimeout(function(){e.removeClass("tdb-s-content-disabled");c.removeClass("tdb-s-btn-saving").removeClass("tdb-s-btn-saved");
setTimeout(function(){a.blockObj.find(".tdb-s-notif-success").remove();a.blockObj.find(".tdb-s-notif-error").remove()},4E3)},200)}}})},addItem:function(a){if("undefined"===typeof a.uid)throw"item.uid is not defined";tdbCustomForms.items.push(a);tdbCustomForms._initialize_item(a)},deleteItem:function(a){for(var d=0;d<tdbCustomForms.items.length;d++)if(tdbCustomForms.items[d].uid===a)return tdbCustomForms.items.splice(d,1),!0;return!1},resetItems:function(){tdbCustomForms.items=[]}}})();
